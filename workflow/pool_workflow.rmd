---
title: "stanmodels"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

set.seed(1)
```

```{r}
library(rstan)
library(loo)
```

# Pooled Model

```{r}
data <- read.csv("../data/preprocessed_data.csv")
data
```

```{r}
x1 <- data[,'Continent']
x2 <- data[, 'Fullscale_IQ_Change']
x3 <- data[,'Schooling_Index']
x4 <- data[,'Decade']
```

## Model with Decade Index

```{r}
IQ <- list(N = length(x3),
           x1 = x4,
           y =  x2,
           xpred = 11)
fit <- stan(file = '../models/pooled/pool.stan', data = IQ)

m <- monitor(fit)
```

```{r}
ans <- extract(fit)
mean(ans$a)
mean(ans$b)
hist(ans$a)
hist(ans$b)
```

```{r}
mean(ans$ypred)
quantile(ans$ypred, c(0.05, 0.1,0.5, 0.9, 0.95))
```

Convergence Analysis

```{r}
fit
check_hmc_diagnostics(fit)
```

```{r}
log_lik_1 <- extract_log_lik(fit, merge_chains = FALSE)
r_eff <- relative_eff(exp(log_lik_1))
loo_1 <- loo(log_lik_1, r_eff = r_eff)
loo_1$estimates
```

## Model with Schooling Index

```{r}
IQ <- list(N = length(x3),
           x1 = x3,
           y = x2)
fit <- stan(file = '../models/pooled/pool_schooling.stan', data = IQ, seed=1)
m <- monitor(fit)
```

```{r}
ans <- extract(fit)
mean(ans$a)
mean(ans$b)
hist(ans$a)
hist(ans$b)
```

Convergence Diagnostics

```{r}
fit
check_hmc_diagnostics(fit)
```

```{r}
log_lik_1 <- extract_log_lik(fit, merge_chains = FALSE)
r_eff <- relative_eff(exp(log_lik_1))
loo_1 <- loo(log_lik_1, r_eff = r_eff)
loo_1$estimates
```

## Model with Decade and Schooling Index

```{r}
IQ <- list(N = length(x3),
           x1 = x4,
           x2 = x3,
           y = x2,
           xpred_decade = 11,
           xpred_schooling = c(0.5, 0.6, 0.7)
)
fit <- stan(file = '../models/pooled/pool_adv.stan', data = IQ, seed=1)
m <- monitor(fit)
```

```{r}
ans <- extract(fit)
hist(ans$a)
mean(ans$a)
hist(ans$b)
mean(ans$b)
hist(ans$c)
```

Convergence Diagnostics

```{r}
fit
check_hmc_diagnostics(fit)
```

```{r}
log_lik_1 <- extract_log_lik(fit, merge_chains = FALSE)
r_eff <- relative_eff(exp(log_lik_1))
loo_1 <- loo(log_lik_1, r_eff = r_eff)
loo_1$estimates
```

```{r}
a <- mean(ans$a)
b <- mean(ans$b)
q_a <- quantile(ans$a, c(0.05, 0.95))
q_b <- quantile(ans$b, c(0.05, 0.95))

plot(x=x4, y=x3, type='p', ylim = c(-0.25,1))
lines(x4, a + b*x4, col ="red")
```

```{r}
a <- mean(ans$a)
b <- mean(ans$b)
q_a <- quantile(ans$a, c(0.05, 0.95))
q_b <- quantile(ans$b, c(0.05, 0.95))

plot(x=x4, y=x3, type='p', ylim=c(-6,6))
lines(x4, a + b*x4, col ="red")
lines(x4, q_a[1] + q_b[1]*x4, lty=3)
lines(x4, q_a[2] + q_b[2]*x4, col="blue", lty=3)
```
