---
title: "BDA Project"
author: "|AUTHORS|"
date: "|DATE|"
output: pdf_document
bibliography: references.bib
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

-   the motivation (these are temporary titles)

**(temp.) WHAT IS IQ?** IQ is a psychometric measurement intended to
measure the test taker's cognitive ability. IQ is by convention normally
distributed with a mean of 100 points and a standard deviation of 15
points. Full-scale IQ is an IQ score derived by averaging over the
results of a test battery of several subtests which are intended to
measure different intelligence domains. IQ tests are not practiced for
and as such are supposed to measure some inherent feature of the test
taker. IQ as a metric has been widely criticized, due to its spurious
relation to an ordinary language understanding of intelligence and
historically grave misuse of results, but remains in wide use. The
observed global trend of the average IQ to rise over generations has
been termed the Flynn effect. [@IQ_paper]. This report does not assume
any position on the validity of IQ as a metric.

-   the problem

-   the main modeling idea

In this report we will attempt to replicate the Flynn effect with our
data and to explore the dependency between IQ change and change in
average years of schooling in the population [@AHDI_paper]. We will
explore these dependencies both globally and per continent. The trend in
IQ will be validated with a model that explores temporal dependency
alone and a further model that factors in schooling level. We will model
the data with a pooled, separate and hierarchical model. The models will
explore the relationship between the passage of time and the development
of IQ scores from the start of testing and the relationship between
schooling level and the development of IQ scores from the start of
testing.

-   showing some illustrative figure **just plot the data as different
    colored points per regions?** **regression lines for each region on
    the same graph?**

# Data description

Our data is a collection of time indexed IQ test score changes for a
given continents (Asia, Europe, Oceania, Africa, America). Successive
data points are the developments in IQ as compared to the first
measurement made, such that at the first Fullscale IQ Change is zero.
Schooling levels are not set to be zero for the first data point but
this didn't seem to cause problems for the models.

The Full-scale IQ data has previously been used in a frequentist
meta-analysis which gathered global historical IQ data from 1909 to 2013
and found global non-linear increases across all IQ domains. Best
explanation for IQ increases was found in increasing nutrition,
education and lower family size. [@IQ_paper].

Our analysis differs in that it is bayesian and studies the relationship
between education level and IQ directly. This approach is vulnerable to
overfitting assuming education level is determined by for example income
level but this is not a concern for us as we are interested in the link
between education level and IQ increase specifically. Schooling level or
time could also both explain both of the models if they are dependent on
each other, as they can be assumed to be. The joint models which take
into account both temporal change and schooling level, were they to
perform better than the separate models, would reveal a d

The education level data has been analysed before with a trend analysis
from 1870 onwards discovering gains globally that do not match global
wealth distribution such that the global middle class has seen the best
gains overall. [@AHDI_paper].

Our analysis is bayesian and concerned with the link to IQ which has not
previously been explored for this data set.

-   Full-scale IQ Data acquired from
    [https://github.com/owid/owid-datasets/tree/master/datasets/IQ%20Data%20-%20Pietschnig%20and%20Voracek%20(2015)](https://github.com/owid/owid-datasets/tree/master/datasets/IQ%20Data%20-%20Pietschnig%20and%20Voracek%20(2015)){.uri}
    (Accessed 2021-11-23), "IQ Data - Pietschnig and Voracek
    (2015).csv", preprocessing discussed in [Appendix A: Preprocessing]
-   Education data acquired from
    <https://frdelpino.es/investigacion/en/category/01_social-sciences/02_world-economy/03_human-development-world-economy/>
    (Accessed 2021-11-23)("AHDI countries 1.1 (xlsx)", table
    "Schooling_Index", preprocessing discussed in [Appendix A:
    Preprocessing])

# Model description

The data is organized into continents so we will model the difference
and similarity in continent behavior with a separate, pooled and
hierarchical model.

The pooled model will pool all results into a global pool for which we
will simulate the following models $$\begin{align*}
  &1: \Delta IQ \sim N(\alpha + \beta \cdot \text{decade}, 1)\\
  &2: \Delta IQ \sim N(\alpha + \gamma \cdot \text{schooling level}, 1)\\\
  &3: \Delta IQ \sim N(\alpha + \beta \cdot \text{decade} + \gamma \cdot \text{schooling level}, 1)\\
\end{align*}$$

Each model will use weakly informative priors such that $$\begin{align*}
  \alpha ~ N(0, 1)\\
  \beta ~ N(0, 50)\\
  \gamma ~ N(0, 100)\\
\end{align*}$$

These priors are based on our prior beliefs as follows: + The model
should naturally intercept at zero, since it is modelling change to the
initial state. The intercept is normally distributed to better detect
unexpected behavior in the model. The variance is quite strict since the
maximum change in IQ in the data is around 40 points but this should not
matter since the model is not concerned with modelling anything at
$t=0$. + The temporal slope $\beta$, a slope that expresses the
dependence between the monotonically increasing decade attribute and the
change in IQ, should be allowed to, in terms of the prior distribution,
explain all the change in the data and allowing for changes outside of
the data. Our prior beliefs dictate that seeing a 100 point change would
be very very unlikely but still allowed in terms of probabilities.
There's conceptually an over-fitting to the data here but a more
dispersed prior would be very strange rationally i.e. a decade resulting
in a 100 IQ point change given that the maximum IQ score is 200. + The
schooling slope, $\gamma$, that expresses the dependence between IQ
change and schooling level is chosen with the same rationale as the
slope $\beta$ expect scaled to fit the smaller data values (schooling
level values vary between 0 and 1 such that 1 implies university level
education). + $y$'s variance, the noise, is distributed normally and
somewhat strictly due to us not wanting for much of the variance to be
explained by noise, believing that a stricter noise would result in us
detecting bad fits for our models more quickly.

The hierarchical model will have continents sharing variance for the
slopes and intercepts such that for continent $c\in C$ \begin{align*}
  \alpha_c ~ N(0, 1)\\
  \beta_c ~ N(0, 50)\\
  \gamma_c ~ N(0, 100)\\
  \sigma ~ N(0, 100)\\
\end{align*} Where $\sigma$ is the shared variance between continents
for the linear combination of attributes. In total, the hierarchical
model is then constructed such that \begin{align*}
  \Delta IQ_c \sim N(\alpha_c + \beta_c \cdot \text{decade} + \gamma_c \cdot \text{schooling level}, \sigma)
\end{align*}

# Stan code

Stan Code ran as follows () how we ran the code (how many chains,
iterations, warmup legnth, example line (fit \<- stan(...)))

Due to its length we have deciced to place the Stan source code in
[Appendix C: Stan source code]

code...

how

# Simulation

```{r include=FALSE}
# libraries
library(rstan)
library(loo)

# read
data <- read.csv("data/preprocessed_data.csv")

# variables

# pool variables
x1 <- data[,'Continent']
x2 <- data[, 'Fullscale_IQ_Change']
x3 <- data[,'Schooling_Index']
x4 <- data[,'Decade']
xpred <- 11
latest_data <- data[data['Decade'] == 10]
n <- length(latest_data)
schooling <- as.numeric(unlist(latest_data[16:n]))
mu <- mean(schooling)
mu_vec <- c(mu * 1.05, mu * 1.1, mu * 1.15)


# sep variables
data1 <- data[data$Continent == "Europe", ]
data2 <- data[data$Continent == "Oceania", ]
data3 <- data[data$Continent == "Africa", ]
data4 <- data[data$Continent == "Asia", ]
data5 <- data[data$Continent == "America", ]


# Data objects for Stan
pool_data_temp <- list(N = length(x3),
           x1 = x4,
           y =  x2,
           xpred = xpred)

pool_data_schooling <- list(N = length(x3),
           x1 = x3,
           y = x2)

pool_data_comb <- list(N = length(x3),
           x1 = x4,
           x2 = x3,
           y = x2,
           xpred_decade = xpred,
           xpred_schooling = mu_vec
)


sep_data_temp <- list(
  C = 5,
  N1 = length(data1$Decade),
  N2 = length(data2$Decade),
  N3 = length(data3$Decade),
  N4 = length(data4$Decade),
  N5 = length(data5$Decade),

  x1 = data1[, "Decade"],
  x2 = data2[, "Decade"],
  x3 = data3[, "Decade"],
  x4 = data4[, "Decade"],
  x5 = data5[, "Decade"],
  
  y1 = data1[, "Fullscale_IQ_Change"],
  y2 = data2[, "Fullscale_IQ_Change"],
  y3 = data3[, "Fullscale_IQ_Change"],
  y4 = data4[, "Fullscale_IQ_Change"],
  y5 = data5[, "Fullscale_IQ_Change"]
)

sep_data_schooling <- list(
  C = 5,
  N1 = length(data1$Decade),
  N2 = length(data2$Decade),
  N3 = length(data3$Decade),
  N4 = length(data4$Decade),
  N5 = length(data5$Decade),

  y1 = data1[, "Fullscale_IQ_Change"],
  y2 = data2[, "Fullscale_IQ_Change"],
  y3 = data3[, "Fullscale_IQ_Change"],
  y4 = data4[, "Fullscale_IQ_Change"],
  y5 = data5[, "Fullscale_IQ_Change"],
  
  z1 = data1[, "Schooling_Index"],
  z2 = data2[, "Schooling_Index"],
  z3 = data3[, "Schooling_Index"],
  z4 = data4[, "Schooling_Index"],
  z5 = data5[, "Schooling_Index"]
)

sep_data_comb <- list(
  C = 5,
  N1 = length(data1$Decade),
  N2 = length(data2$Decade),
  N3 = length(data3$Decade),
  N4 = length(data4$Decade),
  N5 = length(data5$Decade),

  x1 = data1[, "Decade"],
  x2 = data2[, "Decade"],
  x3 = data3[, "Decade"],
  x4 = data4[, "Decade"],
  x5 = data5[, "Decade"],
  
  y1 = data1[, "Fullscale_IQ_Change"],
  y2 = data2[, "Fullscale_IQ_Change"],
  y3 = data3[, "Fullscale_IQ_Change"],
  y4 = data4[, "Fullscale_IQ_Change"],
  y5 = data5[, "Fullscale_IQ_Change"],
  
  z1 = data1[, "Schooling_Index"],
  z2 = data2[, "Schooling_Index"],
  z3 = data3[, "Schooling_Index"],
  z4 = data4[, "Schooling_Index"],
  z5 = data5[, "Schooling_Index"]
)

hier_data_temp <- list(
  C = 5,
  N1 = length(data1$Decade),
  N2 = length(data2$Decade),
  N3 = length(data3$Decade),
  N4 = length(data4$Decade),
  N5 = length(data5$Decade),
  x1 = data1[, "Decade"],
  x2 = data2[, "Decade"],
  x3 = data3[, "Decade"],
  x4 = data4[, "Decade"],
  x5 = data5[, "Decade"],
  
  y1 = data1[, "Fullscale_IQ_Change"],
  y2 = data2[, "Fullscale_IQ_Change"],
  y3 = data3[, "Fullscale_IQ_Change"],
  y4 = data4[, "Fullscale_IQ_Change"],
  y5 = data5[, "Fullscale_IQ_Change"]
)

hier_data_schooling <- list(
  C = 5,
  N1 = length(data1$Decade),
  N2 = length(data2$Decade),
  N3 = length(data3$Decade),
  N4 = length(data4$Decade),
  N5 = length(data5$Decade),
  
  y1 = data1[, "Fullscale_IQ_Change"],
  y2 = data2[, "Fullscale_IQ_Change"],
  y3 = data3[, "Fullscale_IQ_Change"],
  y4 = data4[, "Fullscale_IQ_Change"],
  y5 = data5[, "Fullscale_IQ_Change"],
  
  z1 = data1[, "Schooling_Index"],
  z2 = data2[, "Schooling_Index"],
  z3 = data3[, "Schooling_Index"],
  z4 = data4[, "Schooling_Index"],
  z5 = data5[, "Schooling_Index"]
)

hier_data_comb <- list(
  C = 5,
  N1 = length(data1$Decade),
  N2 = length(data2$Decade),
  N3 = length(data3$Decade),
  N4 = length(data4$Decade),
  N5 = length(data5$Decade),
  x1 = data1[, "Decade"],
  x2 = data2[, "Decade"],
  x3 = data3[, "Decade"],
  x4 = data4[, "Decade"],
  x5 = data5[, "Decade"],
  
  y1 = data1[, "Fullscale_IQ_Change"],
  y2 = data2[, "Fullscale_IQ_Change"],
  y3 = data3[, "Fullscale_IQ_Change"],
  y4 = data4[, "Fullscale_IQ_Change"],
  y5 = data5[, "Fullscale_IQ_Change"],
  
  z1 = data1[, "Schooling_Index"],
  z2 = data2[, "Schooling_Index"],
  z3 = data3[, "Schooling_Index"],
  z4 = data4[, "Schooling_Index"],
  z5 = data5[, "Schooling_Index"]
)
  
#  Stan Models

# Separate Models
fit_sep_temp <- stan(file = 'models/separate/sep_temporal.stan',
                     data = sep_data_temp, 
                     seed=1)

fit_sep_school <- stan(file = 'models/separate/sep_schooling.stan',
                       data = sep_data_schooling, 
                       seed=1)

fit_sep_comb<- stan(file = 'models/separate/sep_joint.stan',
                       data = sep_data_comb, 
                       seed=1)

# Pooled Model
fit_pool_temp <- stan(file = 'models/pooled/pool.stan', 
                      data = pool_data_temp, 
                      seed= 1)

fit_pool_school <- stan(file = 'models/pooled/pool_schooling.stan',
                        data = pool_data_schooling, 
                        seed = 1)

fit_pool_comb <- stan(file = 'models/pooled/pool_adv.stan', 
                      data = pool_data_comb, 
                      seed = 1)
# Hierarchical Mode
fit_hier_temp <- stan(file='models/hierarchical/hier.stan', 
                      data=hier_data_temp, 
                      seed=1)

fit_hier_school <-stan(file='models/hierarchical/hier_school.stan', 
                       data = hier_data_schooling, 
                       seed=1)

fit_hier_comb <- stan(file='models/hierarchical/hier_adv.stan', 
                      data=hier_data_comb, 
                      seed=1)
```

```{r echo=FALSE}
plot(x=a, y=a)
```

convergence diagnostics

+---------+----------+---------+---------+---------+---------+---------+
|         |          | **E     | **Oc    | **A     | *       | **Am    |
|         |          | urope** | eania** | frica** | *Asia** | erica** |
+=========+==========+=========+=========+=========+=========+=========+
|         |          |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| **S     |          |         |         |         |         |         |
| eparate |          |         |         |         |         |         |
| S       |          |         |         |         |         |         |
| imple** |          |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| rhat    | a        | 1.00118 | 1       | 1       | 1       | 1       |
|         |          |         | .002355 | .000308 | .003236 | .000922 |
+---------+----------+---------+---------+---------+---------+---------+
|         | b        | 1.00118 | 1       | 1       | 1       | 1       |
|         |          |         | .002355 | .000308 | .003236 | .000922 |
+---------+----------+---------+---------+---------+---------+---------+
| neff    | a        | 2463    | 2772    | 3051    | 4591    | 3711    |
+---------+----------+---------+---------+---------+---------+---------+
|         | b        | 2502    | 2863    | 2837    | 3584    | 2740    |
+---------+----------+---------+---------+---------+---------+---------+
| Div     | 0 of     |         |         |         |         |         |
| ergence | 3000     |         |         |         |         |         |
|         | it       |         |         |         |         |         |
|         | erations |         |         |         |         |         |
|         | ended    |         |         |         |         |         |
|         | with a   |         |         |         |         |         |
|         | div      |         |         |         |         |         |
|         | ergence. |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| Tree    | 0 of     |         |         |         |         |         |
| Depth   | 3000     |         |         |         |         |         |
|         | it       |         |         |         |         |         |
|         | erations |         |         |         |         |         |
|         | s        |         |         |         |         |         |
|         | aturated |         |         |         |         |         |
|         | the      |         |         |         |         |         |
|         | maximum  |         |         |         |         |         |
|         | tree     |         |         |         |         |         |
|         | depth of |         |         |         |         |         |
|         | 10.      |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
|         |          |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| **S     |          |         |         |         |         |         |
| eparate |          |         |         |         |         |         |
| with    |          |         |         |         |         |         |
| Sc      |          |         |         |         |         |         |
| hooling |          |         |         |         |         |         |
| Index** |          |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| rhat    | a        | 1       | 1       | 1       | 1       | 1       |
|         |          | .000961 | .003344 | .001653 | .000237 | .003206 |
+---------+----------+---------+---------+---------+---------+---------+
|         | c        | 1       | 1       | 1       | 1       | 1       |
|         |          | .000961 | .003344 | .001653 | .000237 | .003206 |
+---------+----------+---------+---------+---------+---------+---------+
| neff    | a        | 2796    | 3866    | 2943    | 4826    | 4676    |
+---------+----------+---------+---------+---------+---------+---------+
|         | c        | 3238    | 3414    | 3080    | 2644    | 3006    |
+---------+----------+---------+---------+---------+---------+---------+
| Div     | 0 of     |         |         |         |         |         |
| ergence | 4000     |         |         |         |         |         |
|         | it       |         |         |         |         |         |
|         | erations |         |         |         |         |         |
|         | ended    |         |         |         |         |         |
|         | with a   |         |         |         |         |         |
|         | di       |         |         |         |         |         |
|         | vergence |         |         |         |         |         |
|         | (0.05%). |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| Tree    | 0 of     |         |         |         |         |         |
| Depth   | 4000     |         |         |         |         |         |
|         | it       |         |         |         |         |         |
|         | erations |         |         |         |         |         |
|         | s        |         |         |         |         |         |
|         | aturated |         |         |         |         |         |
|         | the      |         |         |         |         |         |
|         | maximum  |         |         |         |         |         |
|         | tree     |         |         |         |         |         |
|         | depth of |         |         |         |         |         |
|         | 10.      |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
|         |          |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| **S     |          |         |         |         |         |         |
| eparate |          |         |         |         |         |         |
| with    |          |         |         |         |         |         |
| Decade  |          |         |         |         |         |         |
| and     |          |         |         |         |         |         |
| Sc      |          |         |         |         |         |         |
| hooling |          |         |         |         |         |         |
| Index** |          |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| rhat    | a        | 1.      | 1.      | 1.      | 1.      | 0.      |
|         |          | 0013204 | 0003936 | 0010471 | 0005874 | 9996429 |
+---------+----------+---------+---------+---------+---------+---------+
|         | b        | 1.      | 1.      | 1.      | 1.      | 0.      |
|         |          | 0013204 | 0003936 | 0010471 | 0005874 | 9996429 |
+---------+----------+---------+---------+---------+---------+---------+
|         | c        | 1       | 1       | 1       | 1.00122 | 1.00092 |
|         |          | .001945 | .001503 | .001095 |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| neff    | a        | 2491    | 2362    | 2676    | 5330    | 5337    |
+---------+----------+---------+---------+---------+---------+---------+
|         | b        | 2058    | 1989    | 2270    | 1999    | 2199    |
+---------+----------+---------+---------+---------+---------+---------+
|         | c        | 1896    | 1862    | 2107    | 1982    | 2163    |
+---------+----------+---------+---------+---------+---------+---------+
| Div     | 0 of     |         |         |         |         |         |
| ergence | 4000     |         |         |         |         |         |
|         | it       |         |         |         |         |         |
|         | erations |         |         |         |         |         |
|         | ended    |         |         |         |         |         |
|         | with a   |         |         |         |         |         |
|         | di       |         |         |         |         |         |
|         | vergence |         |         |         |         |         |
|         | (0.05%). |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| Tree    | 0 of     |         |         |         |         |         |
| Depth   | 4000     |         |         |         |         |         |
|         | it       |         |         |         |         |         |
|         | erations |         |         |         |         |         |
|         | s        |         |         |         |         |         |
|         | aturated |         |         |         |         |         |
|         | the      |         |         |         |         |         |
|         | maximum  |         |         |         |         |         |
|         | tree     |         |         |         |         |         |
|         | depth of |         |         |         |         |         |
|         | 10.      |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
|         |          |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| **Hier  |          |         |         |         |         |         |
| S       |          |         |         |         |         |         |
| imple** |          |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| rhat    | a        | 1       | 1.      | 0.      | 1.      | 0.      |
|         |          | .000584 | 0012687 | 9999413 | 0000693 | 9999622 |
+---------+----------+---------+---------+---------+---------+---------+
|         | b        | 0.      | 1.      | 1.      | 1.      | 1.      |
|         |          | 9998691 | 0000395 | 0008906 | 0002912 | 0005587 |
+---------+----------+---------+---------+---------+---------+---------+
| neff    | a        | 4468    | 4302    | 6278    | 5025    | 4971    |
+---------+----------+---------+---------+---------+---------+---------+
|         | b        | 4809    | 4902    | 5227    | 4964    | 5097    |
+---------+----------+---------+---------+---------+---------+---------+
| Div     | 0 of     |         |         |         |         |         |
| ergence | 4000     |         |         |         |         |         |
|         | it       |         |         |         |         |         |
|         | erations |         |         |         |         |         |
|         | ended    |         |         |         |         |         |
|         | with a   |         |         |         |         |         |
|         | div      |         |         |         |         |         |
|         | ergence. |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| Tree    | 0 of     |         |         |         |         |         |
| Depth   | 4000     |         |         |         |         |         |
|         | it       |         |         |         |         |         |
|         | erations |         |         |         |         |         |
|         | s        |         |         |         |         |         |
|         | aturated |         |         |         |         |         |
|         | the      |         |         |         |         |         |
|         | maximum  |         |         |         |         |         |
|         | tree     |         |         |         |         |         |
|         | depth of |         |         |         |         |         |
|         | 10.      |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
|         |          |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| **Hier  |          |         |         |         |         |         |
| Scho    |          |         |         |         |         |         |
| oling** |          |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| rhat    | a        | 1       | 1       | 1       | 1       | 1       |
|         |          | .000805 | .001127 | .000538 | .000633 | .000593 |
+---------+----------+---------+---------+---------+---------+---------+
|         | c        | 1.      | 1.      | 1.      | 1.      | 0.      |
|         |          | 0001844 | 0010336 | 0005288 | 0001078 | 9999031 |
+---------+----------+---------+---------+---------+---------+---------+
| neff    | a        | 4085    | 4013    | 4356    | 4096    | 4373    |
+---------+----------+---------+---------+---------+---------+---------+
|         | c        | 3531    | 3748    | 4119    | 3796    | 4230    |
+---------+----------+---------+---------+---------+---------+---------+
| Div     | 0 of     |         |         |         |         |         |
| ergence | 4000     |         |         |         |         |         |
|         | it       |         |         |         |         |         |
|         | erations |         |         |         |         |         |
|         | ended    |         |         |         |         |         |
|         | with a   |         |         |         |         |         |
|         | div      |         |         |         |         |         |
|         | ergence. |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| Tree    | 0 of     |         |         |         |         |         |
| Depth   | 4000     |         |         |         |         |         |
|         | it       |         |         |         |         |         |
|         | erations |         |         |         |         |         |
|         | s        |         |         |         |         |         |
|         | aturated |         |         |         |         |         |
|         | the      |         |         |         |         |         |
|         | maximum  |         |         |         |         |         |
|         | tree     |         |         |         |         |         |
|         | depth of |         |         |         |         |         |
|         | 10.      |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
|         |          |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| **Hier  |          |         |         |         |         |         |
| Adv     |          |         |         |         |         |         |
| anced** |          |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| rhat    | a        | 1       | 1       | 1       | 1       | 1       |
|         |          | .000985 | .001348 | .002005 | .002113 | .000064 |
+---------+----------+---------+---------+---------+---------+---------+
|         | b        | 1.      | 0.      | 1.      | 1.      | 1.      |
|         |          | 0009266 | 9996498 | 0015432 | 0014392 | 0006435 |
+---------+----------+---------+---------+---------+---------+---------+
|         | c        | 1.      | 0.      | 1.      | 1.      | 1.      |
|         |          | 0010106 | 9994411 | 0020594 | 0014008 | 0005017 |
+---------+----------+---------+---------+---------+---------+---------+
| neff    | a        | 5330    | 5317    | 4498    | 3833    | 5855    |
+---------+----------+---------+---------+---------+---------+---------+
|         | b        | 3490    | 3542    | 2998    | 3012    | 3037    |
+---------+----------+---------+---------+---------+---------+---------+
|         | c        | 3353    | 3421    | 2884    | 2795    | 2970    |
+---------+----------+---------+---------+---------+---------+---------+
| Div     | 0 of     |         |         |         |         |         |
| ergence | 4000     |         |         |         |         |         |
|         | it       |         |         |         |         |         |
|         | erations |         |         |         |         |         |
|         | ended    |         |         |         |         |         |
|         | with a   |         |         |         |         |         |
|         | div      |         |         |         |         |         |
|         | ergence. |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+
| Tree    | 0 of     |         |         |         |         |         |
| Depth   | 4000     |         |         |         |         |         |
|         | it       |         |         |         |         |         |
|         | erations |         |         |         |         |         |
|         | s        |         |         |         |         |         |
|         | aturated |         |         |         |         |         |
|         | the      |         |         |         |         |         |
|         | maximum  |         |         |         |         |         |
|         | tree     |         |         |         |         |         |
|         | depth of |         |         |         |         |         |
|         | 10.      |         |         |         |         |         |
+---------+----------+---------+---------+---------+---------+---------+

Pooled

|                                            | **rhat**                                                     | **neff** |
|--------------------------------------------|--------------------------------------------------------------|----------|
| **Pooled Simple**                          |                                                              |          |
| a                                          | 1.001166                                                     | 2719     |
| b                                          | 1.001959                                                     | 2596     |
| Divergence                                 | 0 of 4000 iterations ended with a divergence.                |          |
| Tree Depth                                 | 0 of 4000 iterations saturated the maximum tree depth of 10. |          |
|                                            |                                                              |          |
| **Pooled with Schooling Index**            |                                                              |          |
| a                                          | 1.000503                                                     | 2858     |
| b                                          | 1.001412                                                     | 2603     |
| Divergence                                 | 0 of 4000 iterations ended with a divergence.                |          |
| Tree Depth                                 | 0 of 4000 iterations saturated the maximum tree depth of 10. |          |
|                                            |                                                              |          |
| **Pooled with Decade and Schooling Index** |                                                              |          |
| a                                          | 1.001149                                                     | 2994     |
| b                                          | 1.001361                                                     | 2195     |
| c                                          | 1.000848                                                     | 2057     |
| Divergence                                 | 0 of 4000 iterations ended with a divergence.                |          |
| Tree Depth                                 | 0 of 4000 iterations saturated the maximum tree depth of 10. |          |

: Convergence Diagnostics for Pooled Model

**Rhat** is roughly the ratio of the parameter variance when the data is
pooled across all of the chains to the within-chain variance. It
basically measures how much the chains are reaching different
conclusions. Since most of the Rhats above are very close to 1, and all
of them are less than 1.1, we can conclude that the chains reach the
same conclusion.

**nEff** is an estimate of the effective sample size of the parameters.
The smaller it is, the greater is the uncertainty associated with its
parameter. A common heuristic is that the nEff needs to be higher than
100 for parameters of interest. Since this is the case with the above
models, we can be sure that there is low uncertainty associated with the
model parameters.

**Divergence** implies that the drawn samples are not from the entire
posterior and thus the inferences will be biased. Since the above models
do not diverge, we can conclude that they sample from the entire
posterior.

Crossing the maximum **tree depth** implies that the optimal number of
steps for each iteration is higher than the currently set maximum. Since
this is not the case in the above models, we can conclude that the
sampler is efficient and the optimal number of steps for each iteration
is less than the maximum tree depth.

posterior predictive chcks

model comparison

# Performance assessment

Plotted values for deltaIQ

PSIS-LOO?

# sensitivity analysis

Prior sensitivity analysis will be done on the simple and advanced
pooled model.

Change intercept $a$ prior from $N(0,1)$ to $N(0, 10)$

Reason: Even though the data starts from the 0-point, it is not
necessary that the best fit line should also start there. The modified
prior offers the y-intercept a bit more freedom in these regards.

Simple Model

```{r, include=FALSE}
IQ <- list(N = length(x3),
           x1 = x4,
           x2 = x3,
           y = x2,
           xpred = 11
)
fit_default <- stan(file = 'models/pooled/pool.stan', data = IQ, seed=1)
ans_default <- extract(fit_default)

fit_prior1 <- stan(file = 'models/pooled/pool_prior1.stan', data = IQ, seed=1)
ans_prior1 <- extract(fit_prior1)
```

```{r, echo=FALSE}
hist( ans_default$a, col="lightblue", xlab="a", main="Histogram of a with different priors for simple pooled model")  # first histogram
hist( ans_prior1$a, col=rgb(1,0,0,1/4), add=T)  # second
legend(x="topright", legend=c("Normal Prior", "Modified Prior"), fill=c("lightblue", rgb(1,0,0,1/4)))

```

Advanced Model

```{r, include=FALSE}
IQ <- list(N = length(x3),
           x1 = x4,
           x2 = x3,
           y = x2,
           xpred_decade = 11,
           xpred_schooling = mu_vec
)
fit_default <- stan(file = 'models/pooled/pool_adv.stan', data = IQ, seed=1)
ans_default <- extract(fit_default)

fit_prior1 <- stan(file = 'models/pooled/pool_adv_prior1.stan', data = IQ, seed=1)
ans_prior1 <- extract(fit_prior1)
```

```{r, echo=FALSE}
hist( ans_default$a, col="lightblue", xlab="a", "Histogram of a with different priors for advanced pooled model")  # first histogram
hist( ans_prior1$a, col=rgb(1,0,0,1/4), add=T)  # second
legend(x="topright", legend=c("Normal Prior", "Modified Prior"), fill=c("lightblue", rgb(1,0,0,1/4)))

```

Analysis: $a$'s distribution, when the prior is changed from $N(0,1)$ to
$N(0,10)$ remains a normal distribution but shifts its center from
$0.86$ to $2.4$. This implies that our model is sensitive to the prior
distribution of $a$.

Change $\sigma$ prior from $N(0, 100)$ to $Inv-\chi^2(1)$

Reason: Inverse-chi squared is generally used as the prior for an
unknown variance of the normal distribution. This is so because it is a
conjugate prior, which for example makes the computations easier, and it
also satisfies the minimal requirements needed for a prior variance.

Simple Model

```{r, include=FALSE}
IQ <- list(N = length(x3),
           x1 = x4,
           x2 = x3,
           y = x2,
           xpred = 11
)
fit_default <- stan(file = 'models/pooled/pool.stan', data = IQ, seed=1)
ans_default <- extract(fit_default)

fit_prior2 <- stan(file = 'models/pooled/pool_prior2.stan', data = IQ, seed=1)
ans_prior2 <- extract(fit_prior1)
```

```{r, echo=FALSE}
hist( ans_default$sigma, col="lightblue", xlab="sigma", main="Histogram of sigma with different priors for simple pooled model")  # first histogram
hist( ans_prior2$sigma, col=rgb(1,0,0,1/4), add=T)  # second
legend(x="topright", legend=c("Normal Prior", "Modified Prior"), fill=c("lightblue", rgb(1,0,0,1/4)))
```

Advanced Model

```{r, include=FALSE}
IQ <- list(N = length(x3),
           x1 = x4,
           x2 = x3,
           y = x2,
           xpred_decade = 11,
           xpred_schooling = mu_vec
)
fit_default <- stan(file = 'models/pooled/pool_adv.stan', data = IQ, seed=1)
ans_default <- extract(fit_default)

fit_prior2 <- stan(file = 'models/pooled/pool_adv_prior2.stan', data = IQ, seed=1)
ans_prior2 <- extract(fit_prior1)
```

```{r, echo=FALSE}
hist( ans_default$sigma, col="lightblue", xlab="sigma", main="Histogram of sigma with different priors for advanced pooled model")  # first histogram
hist( ans_prior2$sigma, col=rgb(1,0,0,1/4), add=T)  # second
legend(x="topright", legend=c("Normal Prior", "Modified Prior"), fill=c("lightblue", rgb(1,0,0,1/4)))
```

Analysis: $\sigma$'s distribution stays almost identical when changed
from $N(0,100)$ to $inv-\chi^2(1)$. This implies that our model is
insensitive to the prior distribution of sigma.

# Posterior predictive checking

Done for pooled models \# Prediction

> prediciton did it make sense?

# Issues and improvements

Close to the end of the project we noticed that our data had been
constructed in a way that is conceptually difficult for linear
regression. Mainly the same explanatory variable value would lead to
different response variable values. This does not cause problems for the
linear regression algorithms used but makes understanding the data more
difficult. In essence a concrete uncertainty in the data. Changing this
however didn't alter our results in terms of model selection or relative
PSIS-LOOs so we decided to leave it as is.

# Conclusion

what did we learn about the data

We eneded up with the XXXXXX model... \>validated the flynn effect
\>found some osrt of dependece between deltaIQ and schooling level \#
Self-reflection

We also should have consulted the TAs more but, even though we started
early, we didn't have time to do this because the project started to
concretize later than we expected due to our slow progress. This meant
that at the point at which questions arose we no longer had time to ask
them. This was due to a failure in planning and overestimating our pace.
From this we learned to be better planners.

# References

::: {#refs}
:::

# Appendix

## Appendix A: Preprocessing

## Appendix B: R source code

!!!!!!!!!!!!!!!!!COPY ALL IMPORTANT CODEZ HERE

## Appendix C: Stan source code
